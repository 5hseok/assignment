{% extends 'base.html' %}

{% block title %}작가 등록 신청 관리 - 오픈갤러리{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>작가 등록 신청 관리</h2>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-success" onclick="processApplications('approve')">선택 항목 승인</button>
        <button type="button" class="btn btn-danger" onclick="processApplications('reject')">선택 항목 반려</button>
    </div>
</div>

{% if search_query %}
    <div class="alert alert-info">
        "{{ search_query }}"에 대한 검색 결과
        <a href="{% url 'artists:admin_applications' %}" class="btn btn-sm btn-outline-secondary ms-2">전체 보기</a>
    </div>
{% endif %}

<div class="card">
    <div class="card-body">
        <form method="get" class="mb-3">
            <div class="row">
                <div class="col-md-10">
                    <input type="text" name="search" class="form-control" placeholder="이름, 이메일, 연락처로 검색..." 
                           value="{{ search_query }}">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" type="submit">검색</button>
                </div>
            </div>
        </form>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>이름</th>
                        <th>성별</th>
                        <th>생년월일</th>
                        <th>이메일</th>
                        <th>연락처</th>
                        <th>신청일시</th>
                        <th>상태</th>
                        <th>처리일시</th>
                    </tr>
                </thead>
                <tbody>
                    {% for application in applications %}
                        <tr>
                            <td>
                                {% if application.status == 'pending' %}
                                    <input type="checkbox" class="application-checkbox" value="{{ application.id }}">
                                {% endif %}
                            </td>
                            <td>{{ application.name }}</td>
                            <td>{{ application.gender }}</td>
                            <td>{{ application.birthday }}</td>
                            <td>{{ application.email }}</td>
                            <td>{{ application.phone_number }}</td>
                            <td>{{ application.applied_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                {% if application.status == 'pending' %}
                                    <span class="badge bg-warning">대기중</span>
                                {% elif application.status == 'approved' %}
                                    <span class="badge bg-success">승인</span>
                                {% else %}
                                    <span class="badge bg-danger">반려</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if application.processed_at %}
                                    {{ application.processed_at|date:"Y-m-d H:i" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">
                                {% if search_query %}
                                    검색 결과가 없습니다.
                                {% else %}
                                    작가 등록 신청이 없습니다.
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Hidden CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.application-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function processApplications(action) {
    const selectedIds = [];
    const checkboxes = document.querySelectorAll('.application-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        selectedIds.push(checkbox.value);
    });
    
    if (selectedIds.length === 0) {
        alert('처리할 신청을 선택해주세요.');
        return;
    }
    
    const actionText = action === 'approve' ? '승인' : '반려';
    if (!confirm(`선택된 ${selectedIds.length}개의 신청을 ${actionText} 처리하시겠습니까?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('action', action);
    selectedIds.forEach(id => {
        formData.append('application_ids', id);
    });
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "artists:process_applications" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('오류가 발생했습니다: ' + data.error);
        }
    })
    .catch(error => {
        alert('네트워크 오류가 발생했습니다.');
        console.error('Error:', error);
    });
}
</script>
{% endblock %}
